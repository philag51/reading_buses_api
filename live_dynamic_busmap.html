<!DOCTYPE html>
<html>
<head>
  <title>Live Bus Route 17 Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map { height: 100vh; }
    .bus-icon {
      background-color: #4B2580;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const API_URL = "https://reading-opendata.r2p.com/api/v1/vehicle-positions?api_token=API_Key"; //Paste your API Key 
    const REFRESH_INTERVAL = 30000; // milliseconds
    let map = L.map('map').setView([51.456, -0.969], 13);
    let markers = {};

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    function createCustomIcon(service) {
      return L.divIcon({
        className: 'bus-icon',
        html: service || "17",
        iconSize: [30, 30]
      });
    }

    function updateMap() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          const seenVehicles = new Set();

          data.forEach(bus => {
            if (bus.operator === "RBUS" && bus.service === "17") {
              const id = bus.vehicle;
              seenVehicles.add(id);

              const lat = parseFloat(bus.latitude);
              const lon = parseFloat(bus.longitude);
              const popup = `Bus ${bus.vehicle} (Route 17)<br>Seen: ${bus.observed}`;

              if (markers[id]) {
                // Move marker
                markers[id].setLatLng([lat, lon]);
                markers[id].setPopupContent(popup);
              } else {
                // Add new marker
                const marker = L.marker([lat, lon], {
                  icon: createCustomIcon("17")
                }).addTo(map).bindPopup(popup);
                markers[id] = marker;
              }
            }
          });

          // Remove any old markers no longer in the data
          for (const id in markers) {
            if (!seenVehicles.has(id)) {
              map.removeLayer(markers[id]);
              delete markers[id];
            }
          }
        })
        .catch(err => console.error("Failed to fetch bus data:", err));
    }

    // Initial load and set interval
    updateMap();
    setInterval(updateMap, REFRESH_INTERVAL);
  </script>
</body>
</html>

